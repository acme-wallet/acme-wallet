name: CI/CD

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/api
  NODE_VERSION: 22
  PNPM_VERSION: 10.29.2
  TURBO_CACHE_DIR: .turbo

jobs:
  # ──────────────────────────────────────────────
  # Detect which areas of the monorepo changed
  # ──────────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
      packages: ${{ steps.filter.outputs.packages }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/database/**'
              - 'packages/schemas/**'
              - 'pnpm-lock.yaml'
            web:
              - 'apps/web/**'
              - 'packages/schemas/**'
              - 'pnpm-lock.yaml'
            packages:
              - 'packages/**'

  # ──────────────────────────────────────────────
  # CI: API — Lint, Typecheck, Test
  # Runs only when api or its dependencies change
  # ──────────────────────────────────────────────
  ci-api:
    name: "CI: API"
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necessário para o Turbo calcular hashes corretamente

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Configuração manual do Cache do Turborepo
      - name: Turbo Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.TURBO_CACHE_DIR }}
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-

      - name: Generate Prisma client
        run: pnpm --filter @repo/db run db:generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      - name: Build packages
        run: pnpm --filter api... run build
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      - name: Lint & Typecheck
        run: |
          pnpm --filter api run lint
          pnpm --filter api run typecheck

      - name: Unit Tests
        run: pnpm --filter api run test

      - name: Integration Tests
        run: pnpm --filter api run test:integration
        env:
          NODE_ENV: test

  # ──────────────────────────────────────────────
  # CI: Web — Lint, Typecheck, Test
  # Runs only when web or its dependencies change
  # ──────────────────────────────────────────────
  ci-web:
    name: "CI: Web"
    needs: changes
    if: needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm --filter web... run build

      - name: Lint
        run: pnpm --filter web run lint

      - name: Typecheck
        run: pnpm --filter web run typecheck

      - name: Unit Tests
        run: pnpm --filter web run test

  # ──────────────────────────────────────────────
  # CD: Build Docker image & Push to registry
  # Runs only on push to master when API changed
  # ──────────────────────────────────────────────
  cd-api:
    name: "CD: Build & Push API Image"
    needs: [changes, ci-api]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/master' &&
      needs.changes.outputs.api == 'true' &&
      needs.ci-api.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/api/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
